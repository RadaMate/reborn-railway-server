<!DOCTYPE html>
<html>
<head>
  <title>Re.born is Listening</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: monospace;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }
    button {
      padding: 1rem;
      background: #fff;
      border: none;
      color: black;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2rem;
      margin-bottom: 2rem;
    }
    #output {
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    #response {
      font-size: 1.2rem;
      color: #aaaaff;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Re.born is Listening</h1>
  <button id="startBtn">Start Listening</button>
  <div id="output"><strong>You said:</strong><br></div>
  <div id="response"><strong>Re.born replies:</strong><br></div>

  <script>
  const channel = new BroadcastChannel("reborn_hydra_channel");

  function awaken() {
    channel.postMessage({ type: "awaken" });
  }

  function sendWord(word) {
    channel.postMessage({ type: "word", word });
  }
</script>


    function awaken() {
      channel.postMessage({ type: "awaken" });
    }

    function sendWord(word) {
      channel.postMessage({ type: "word", word });
    }

    function handleTranscript(text) {
      const words = text.trim().split(/\s+/);
      document.getElementById("output").innerHTML =
        "<strong>You said:</strong><br>" + text;
      words.forEach((word, i) => {
        setTimeout(() => sendWord(word), i * 250);
      });
    }

    function showGPTResponse(text) {
      document.getElementById("response").innerHTML =
        "<strong>Re.born replies:</strong><br>" + text;
    }

    async function startListening() {
      awaken();

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      const chunks = [];

      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file', blob, 'audio.webm');

        try {
          const response = await fetch("/upload-audio/", {
            method: "POST",
            body: formData
          });

          const data = await response.json();
          if (data.transcription) {
            handleTranscript(data.transcription);
          }
          if (data.gpt_output) {
            showGPTResponse(data.gpt_output);
          }
        } catch (err) {
          console.error("Upload/transcription failed:", err);
        }
      };

      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), 6000);
    }

    document.getElementById("startBtn").addEventListener("click", startListening);
  </script>
</body>
</html>
